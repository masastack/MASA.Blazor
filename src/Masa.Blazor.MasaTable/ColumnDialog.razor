@using System.Text.Json
<MDialog @bind-Value="_menu"
         MaxWidth="340"
         ContentClass="px-6 pt-7 pb-6"
         Persistent>
    <MForm OnValidSubmit="@HandleOnSubmit">
        <MTextField @bind-Value="@_columnName"
                    Filled
                    TValue="string"
                    OnChange="@HandleOnColumnNameChange"
                    Label="column-name"
                    Required>
        </MTextField>
        <MSelect @bind-Value="@_columnType"
                 Items="@_columnTypeMetadata"
                 ItemValue="u => u.Value"
                 ItemText="u => u.Name"
                 Filled
                 Label="column-type"
                 TItem="(string Name, ColumnType Value)"
                 TItemValue="ColumnType"
                 TValue="ColumnType"
                 OnSelect="@HandleOnColumnTypeSelect">
        </MSelect>
        @if (_columnType == ColumnType.Date)
        {
            <DateInputs @bind-Value="@_additionalValue"/>
        }
        <div class="d-flex justify-end">
            <MButton Class="mr-2" OnClick="@(() => _menu = false)">Cancel</MButton>
            <MButton Type="submit" Color="primary">Confirm</MButton>
        </div>
    </MForm>
</MDialog>

@code {

    [Parameter] public EventCallback<Column> OnSave { get; set; }

    private bool _menu;

    private Column? _column;

    private ColumnType _columnType;
    private string? _columnName;
    private string? _additionalValue;

    private bool _isNameDirty;

    private static IList<(string Name, ColumnType Value)> _columnTypeMetadata = GetEnumMetadata<ColumnType>();

    private void HandleOnColumnNameChange()
    {
        _isNameDirty = true;
    }

    private void HandleOnColumnTypeSelect(((string Name, ColumnType Value) Item, bool Selected) item)
    {
        _additionalValue = null;

        if (_isNameDirty)
        {
            return;
        }

        _columnName = item.Item.Name;
    }

    private void HandleOnSubmit()
    {
        _column ??= new();
        _column.Name = _columnName;
        _column.Type = _columnType;
        _column.AdditionalValue = _additionalValue;
        OnSave.InvokeAsync(_column);
        _menu = false;
    }

    public static IList<(string Name, T Value)> GetEnumMetadata<T>() where T : Enum
    {
        var metadataList = new List<(string Name, T Value)>();
        foreach (var value in Enum.GetValues(typeof(T)))
        {
            metadataList.Add((value.ToString(), (T)value));
        }

        return metadataList;
    }

    internal void Open(Column column)
    {
        _column = column;

        _columnName = column.Name;
        _columnType = column.Type;
        _menu = true;
        StateHasChanged();
    }

    internal void Open()
    {
        _columnName = nameof(ColumnType.Text);
        _columnType = ColumnType.Text;
        _isNameDirty = false;
        _menu = true;
        StateHasChanged();
    }

}
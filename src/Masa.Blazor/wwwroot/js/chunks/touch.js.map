{"version":3,"file":"touch.js","sources":["../../../../Masa.Blazor.JS/src/mixins/touch.ts"],"sourcesContent":["// The code is derived from Vuetify\r\n// License: MIT\r\n// Location: https://github.com/vuetifyjs/vuetify/blob/master/packages/vuetify/src/composables/touch.ts\r\n\r\nclass CircularBuffer<T = never> {\r\n  readonly #arr: Array<T> = []\r\n  #pointer = 0\r\n\r\n  constructor (public readonly size: number) {}\r\n\r\n  push (val: T) {\r\n    this.#arr[this.#pointer] = val\r\n    this.#pointer = (this.#pointer + 1) % this.size\r\n  }\r\n\r\n  values (): T[] {\r\n    return this.#arr.slice(this.#pointer).concat(this.#arr.slice(0, this.#pointer))\r\n  }\r\n}\r\n\r\nconst HORIZON = 100 // ms\r\nconst HISTORY = 20 // number of samples to keep\r\n\r\nexport interface Sample {\r\n  t: number\r\n  d: number\r\n}\r\n\r\n/** @see https://android.googlesource.com/platform/frameworks/native/+/master/libs/input/VelocityTracker.cpp */\r\nfunction kineticEnergyToVelocity (work: number) {\r\n  const sqrt2 = 1.41421356237\r\n  return (work < 0 ? -1.0 : 1.0) * Math.sqrt(Math.abs(work)) * sqrt2\r\n}\r\n\r\n/**\r\n * Returns pointer velocity in px/s\r\n */\r\nexport function calculateImpulseVelocity (samples: Sample[]) {\r\n  // The input should be in reversed time order (most recent sample at index i=0)\r\n  if (samples.length < 2) {\r\n    // if 0 or 1 points, velocity is zero\r\n    return 0\r\n  }\r\n  // if (samples[1].t > samples[0].t) {\r\n  //   // Algorithm will still work, but not perfectly\r\n  //   consoleWarn('Samples provided to calculateImpulseVelocity in the wrong order')\r\n  // }\r\n  if (samples.length === 2) {\r\n    // if 2 points, basic linear calculation\r\n    if (samples[1].t === samples[0].t) {\r\n      // consoleWarn(`Events have identical time stamps t=${samples[0].t}, setting velocity = 0`)\r\n      return 0\r\n    }\r\n    return (samples[1].d - samples[0].d) / (samples[1].t - samples[0].t)\r\n  }\r\n  // Guaranteed to have at least 3 points here\r\n  // start with the oldest sample and go forward in time\r\n  let work = 0\r\n  for (let i = samples.length - 1; i > 0; i--) {\r\n    if (samples[i].t === samples[i - 1].t) {\r\n      // consoleWarn(`Events have identical time stamps t=${samples[i].t}, skipping sample`)\r\n      continue\r\n    }\r\n    const vprev = kineticEnergyToVelocity(work) // v[i-1]\r\n    const vcurr = (samples[i].d - samples[i - 1].d) / (samples[i].t - samples[i - 1].t) // v[i]\r\n    work += (vcurr - vprev) * Math.abs(vcurr)\r\n    if (i === samples.length - 1) {\r\n      work *= 0.5\r\n    }\r\n  }\r\n  return kineticEnergyToVelocity(work) * 1000\r\n}\r\n\r\nexport function useVelocity () {\r\n  const touches: Record<number, CircularBuffer<[number, Touch]> | undefined> = {}\r\n\r\n  function addMovement (e: TouchEvent) {\r\n    Array.from(e.changedTouches).forEach(touch => {\r\n      const samples = touches[touch.identifier] ?? (touches[touch.identifier] = new CircularBuffer(HISTORY))\r\n      samples.push([e.timeStamp, touch])\r\n    })\r\n  }\r\n\r\n  function endTouch (e: TouchEvent) {\r\n    Array.from(e.changedTouches).forEach(touch => {\r\n      delete touches[touch.identifier]\r\n    })\r\n  }\r\n\r\n  function getVelocity (id: number) {\r\n    const samples = touches[id]?.values().reverse()\r\n\r\n    if (!samples) {\r\n      throw new Error(`No samples for touch id ${id}`)\r\n    }\r\n\r\n    const newest = samples[0]\r\n    const x: Sample[] = []\r\n    const y: Sample[] = []\r\n    for (const val of samples) {\r\n      if (newest[0] - val[0] > HORIZON) break\r\n\r\n      x.push({ t: val[0], d: val[1].clientX })\r\n      y.push({ t: val[0], d: val[1].clientY })\r\n    }\r\n\r\n    return {\r\n      x: calculateImpulseVelocity(x),\r\n      y: calculateImpulseVelocity(y),\r\n      get direction () {\r\n        const { x, y } = this\r\n        const [absX, absY] = [Math.abs(x), Math.abs(y)]\r\n\r\n        return absX > absY && x >= 0 ? 'right'\r\n          : absX > absY && x <= 0 ? 'left'\r\n          : absY > absX && y >= 0 ? 'down'\r\n          : absY > absX && y <= 0 ? 'up'\r\n          : oops()\r\n      },\r\n    }\r\n  }\r\n\r\n  return { addMovement, endTouch, getVelocity }\r\n}\r\n\r\nfunction oops (): never {\r\n  throw new Error()\r\n}\r\n"],"names":[],"mappings":";;AAAA;AACA;AACA;;AAEA,MAAM,cAAc,CAAA;AAIlB,IAAA,WAAA,CAA6B,IAAY,EAAA;QAAZ,IAAI,CAAA,IAAA,GAAJ,IAAI,CAAQ;AAHzC,QAAA,mBAAA,CAAA,GAAA,CAAA,IAAA,EAA0B,EAAE,CAAA,CAAA;AAC5B,QAAA,uBAAA,CAAA,GAAA,CAAA,IAAA,EAAW,CAAC,CAAA,CAAA;KAEiC;AAE7C,IAAA,IAAI,CAAE,GAAM,EAAA;QACV,sBAAA,CAAA,IAAI,2BAAK,CAAC,sBAAA,CAAA,IAAI,EAAS,uBAAA,EAAA,GAAA,CAAA,CAAC,GAAG,GAAG,CAAA;AAC9B,QAAA,sBAAA,CAAA,IAAI,EAAA,uBAAA,EAAY,CAAC,sBAAA,CAAA,IAAI,EAAS,uBAAA,EAAA,GAAA,CAAA,GAAG,CAAC,IAAI,IAAI,CAAC,IAAI,MAAA,CAAA;KAChD;IAED,MAAM,GAAA;QACJ,OAAO,sBAAA,CAAA,IAAI,EAAA,mBAAA,EAAA,GAAA,CAAK,CAAC,KAAK,CAAC,sBAAA,CAAA,IAAI,EAAA,uBAAA,EAAA,GAAA,CAAS,CAAC,CAAC,MAAM,CAAC,uBAAA,IAAI,EAAA,mBAAA,EAAA,GAAA,CAAK,CAAC,KAAK,CAAC,CAAC,EAAE,sBAAA,CAAA,IAAI,EAAA,uBAAA,EAAA,GAAA,CAAS,CAAC,CAAC,CAAA;KAChF;AACF,CAAA;;AAED,MAAM,OAAO,GAAG,GAAG,CAAA;AACnB,MAAM,OAAO,GAAG,EAAE,CAAA;AAOlB;AACA,SAAS,uBAAuB,CAAE,IAAY,EAAA;IAC5C,MAAM,KAAK,GAAG,aAAa,CAAA;AAC3B,IAAA,OAAO,CAAC,IAAI,GAAG,CAAC,GAAG,CAAC,GAAG,GAAG,GAAG,IAAI,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,GAAG,KAAK,CAAA;AACpE,CAAC;AAED;;AAEG;AACG,SAAU,wBAAwB,CAAE,OAAiB,EAAA;;AAEzD,IAAA,IAAI,OAAO,CAAC,MAAM,GAAG,CAAC,EAAE;;AAEtB,QAAA,OAAO,CAAC,CAAA;AACT,KAAA;;;;;AAKD,IAAA,IAAI,OAAO,CAAC,MAAM,KAAK,CAAC,EAAE;;AAExB,QAAA,IAAI,OAAO,CAAC,CAAC,CAAC,CAAC,CAAC,KAAK,OAAO,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE;;AAEjC,YAAA,OAAO,CAAC,CAAA;AACT,SAAA;AACD,QAAA,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,OAAO,CAAC,CAAC,CAAC,CAAC,CAAC,KAAK,OAAO,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,OAAO,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAA;AACrE,KAAA;;;IAGD,IAAI,IAAI,GAAG,CAAC,CAAA;AACZ,IAAA,KAAK,IAAI,CAAC,GAAG,OAAO,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE,EAAE;AAC3C,QAAA,IAAI,OAAO,CAAC,CAAC,CAAC,CAAC,CAAC,KAAK,OAAO,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,EAAE;;YAErC,SAAQ;AACT,SAAA;QACD,MAAM,KAAK,GAAG,uBAAuB,CAAC,IAAI,CAAC,CAAA;AAC3C,QAAA,MAAM,KAAK,GAAG,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,OAAO,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,KAAK,OAAO,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,OAAO,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAA;AACnF,QAAA,IAAI,IAAI,CAAC,KAAK,GAAG,KAAK,IAAI,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,CAAA;AACzC,QAAA,IAAI,CAAC,KAAK,OAAO,CAAC,MAAM,GAAG,CAAC,EAAE;YAC5B,IAAI,IAAI,GAAG,CAAA;AACZ,SAAA;AACF,KAAA;AACD,IAAA,OAAO,uBAAuB,CAAC,IAAI,CAAC,GAAG,IAAI,CAAA;AAC7C,CAAC;SAEe,WAAW,GAAA;IACzB,MAAM,OAAO,GAAgE,EAAE,CAAA;IAE/E,SAAS,WAAW,CAAE,CAAa,EAAA;AACjC,QAAA,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC,cAAc,CAAC,CAAC,OAAO,CAAC,KAAK,IAAG;;YAC3C,MAAM,OAAO,GAAG,CAAA,EAAA,GAAA,OAAO,CAAC,KAAK,CAAC,UAAU,CAAC,MAAA,IAAA,IAAA,EAAA,KAAA,KAAA,CAAA,GAAA,EAAA,IAAK,OAAO,CAAC,KAAK,CAAC,UAAU,CAAC,GAAG,IAAI,cAAc,CAAC,OAAO,CAAC,CAAC,CAAA;YACtG,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,SAAS,EAAE,KAAK,CAAC,CAAC,CAAA;AACpC,SAAC,CAAC,CAAA;KACH;IAED,SAAS,QAAQ,CAAE,CAAa,EAAA;AAC9B,QAAA,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC,cAAc,CAAC,CAAC,OAAO,CAAC,KAAK,IAAG;AAC3C,YAAA,OAAO,OAAO,CAAC,KAAK,CAAC,UAAU,CAAC,CAAA;AAClC,SAAC,CAAC,CAAA;KACH;IAED,SAAS,WAAW,CAAE,EAAU,EAAA;;AAC9B,QAAA,MAAM,OAAO,GAAG,CAAA,EAAA,GAAA,OAAO,CAAC,EAAE,CAAC,MAAA,IAAA,IAAA,EAAA,KAAA,KAAA,CAAA,GAAA,KAAA,CAAA,GAAA,EAAA,CAAE,MAAM,EAAA,CAAG,OAAO,EAAE,CAAA;QAE/C,IAAI,CAAC,OAAO,EAAE;AACZ,YAAA,MAAM,IAAI,KAAK,CAAC,2BAA2B,EAAE,CAAA,CAAE,CAAC,CAAA;AACjD,SAAA;AAED,QAAA,MAAM,MAAM,GAAG,OAAO,CAAC,CAAC,CAAC,CAAA;QACzB,MAAM,CAAC,GAAa,EAAE,CAAA;QACtB,MAAM,CAAC,GAAa,EAAE,CAAA;AACtB,QAAA,KAAK,MAAM,GAAG,IAAI,OAAO,EAAE;YACzB,IAAI,MAAM,CAAC,CAAC,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC,GAAG,OAAO;gBAAE,MAAK;YAEvC,CAAC,CAAC,IAAI,CAAC,EAAE,CAAC,EAAE,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,EAAE,GAAG,CAAC,CAAC,CAAC,CAAC,OAAO,EAAE,CAAC,CAAA;YACxC,CAAC,CAAC,IAAI,CAAC,EAAE,CAAC,EAAE,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,EAAE,GAAG,CAAC,CAAC,CAAC,CAAC,OAAO,EAAE,CAAC,CAAA;AACzC,SAAA;QAED,OAAO;AACL,YAAA,CAAC,EAAE,wBAAwB,CAAC,CAAC,CAAC;AAC9B,YAAA,CAAC,EAAE,wBAAwB,CAAC,CAAC,CAAC;AAC9B,YAAA,IAAI,SAAS,GAAA;AACX,gBAAA,MAAM,EAAE,CAAC,EAAE,CAAC,EAAE,GAAG,IAAI,CAAA;gBACrB,MAAM,CAAC,IAAI,EAAE,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAA;gBAE/C,OAAO,IAAI,GAAG,IAAI,IAAI,CAAC,IAAI,CAAC,GAAG,OAAO;sBAClC,IAAI,GAAG,IAAI,IAAI,CAAC,IAAI,CAAC,GAAG,MAAM;0BAC9B,IAAI,GAAG,IAAI,IAAI,CAAC,IAAI,CAAC,GAAG,MAAM;8BAC9B,IAAI,GAAG,IAAI,IAAI,CAAC,IAAI,CAAC,GAAG,IAAI;kCAC5B,IAAI,EAAE,CAAA;aACX;SACF,CAAA;KACF;AAED,IAAA,OAAO,EAAE,WAAW,EAAE,QAAQ,EAAE,WAAW,EAAE,CAAA;AAC/C,CAAC;AAED,SAAS,IAAI,GAAA;IACX,MAAM,IAAI,KAAK,EAAE,CAAA;AACnB;;;;"}
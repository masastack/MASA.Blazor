{"version":3,"file":"ssr-state-restore.js","sources":["../../../BlazorComponent/src/Component/BlazorComponent.Web/src/ssr/index.ts","../../../BlazorComponent/src/Component/BlazorComponent.Web/src/ssr/page-script.ts","../../../BlazorComponent/src/Component/BlazorComponent.Web/src/ssr/ssr-state-restore.ts"],"sourcesContent":["export type MasaBlazorApplication = {\r\n  bar?: number;\r\n  top: number;\r\n  right: number;\r\n  bottom: number;\r\n  left: number;\r\n  footer?: number;\r\n  insetFooter?: number;\r\n};\r\n\r\nexport type MasaBlazorSsrPassiveState = {\r\n  application: MasaBlazorApplication;\r\n};\r\n\r\nexport type MasaBlazorSsrState = {\r\n  culture?: string;\r\n  rtl?: boolean;\r\n  dark?: boolean;\r\n  passive: MasaBlazorSsrPassiveState;\r\n};\r\n\r\nexport const MASA_BLAZOR_SSR_STATE = \"masablazor@ssr-state\";\r\n\r\nexport function setTheme(dark: boolean) {\r\n  console.log(\"[index.ts] setTheme\", dark);\r\n  const selector = `.${getThemeCss(!dark)}:not(.theme--independent)`\r\n  const elements = document.querySelectorAll(selector);\r\n  for (let i = 0; i < elements.length; i++) {\r\n    elements[i].classList.remove(getThemeCss(!dark));\r\n    elements[i].classList.add(getThemeCss(dark));\r\n  }\r\n\r\n  updateStorage({ dark });\r\n}\r\n\r\nexport function setCulture(culture: string) {\r\n  console.log(\"[index.ts] setCulture\", culture);\r\n  const app = getApp();\r\n  if (!app) return;\r\n\r\n  updateStorage({ culture });\r\n}\r\n\r\nexport function setRtl(rtl: boolean, updateCache: boolean = true) {\r\n  console.log(\"[index.ts] setRtl\", rtl);\r\n  const app = getApp();\r\n  if (!app) return;\r\n\r\n  const rtlCss = \"m-application--is-rtl\";\r\n  if (!rtl) {\r\n    app.classList.remove(rtlCss);\r\n  } else if (!app.classList.contains(rtlCss)) {\r\n    app.classList.add(rtlCss);\r\n  }\r\n\r\n  if (updateCache) {\r\n    updateStorage({ rtl });\r\n  }\r\n}\r\n\r\nexport function updateMain(application: MasaBlazorApplication) {\r\n  const main: HTMLElement = document.querySelector(\".m-main\");\r\n\r\n  const newApplication: MasaBlazorApplication = {\r\n    top: application.top ?? getPadding(\"Top\"),\r\n    right: application.right ?? getPadding(\"Right\"),\r\n    bottom: application.bottom ?? getPadding(\"Bottom\"),\r\n    left: application.left ?? getPadding(\"Left\"),\r\n  };\r\n\r\n  restoreMain(newApplication);\r\n\r\n  function getPadding(prop: \"Top\" | \"Right\" | \"Bottom\" | \"Left\") {\r\n    return Number(main.style[`padding${prop}`].match(/\\d+/)[0]);\r\n  }\r\n}\r\n\r\nexport function updatePassiveState(passive: MasaBlazorSsrPassiveState) {\r\n  const oldState = getState() ?? {};\r\n  const state: MasaBlazorSsrState = {\r\n    ...oldState,\r\n    passive,\r\n  };\r\n  console.log(\"[updatePassiveState] state\", state);\r\n  localStorage.setItem(MASA_BLAZOR_SSR_STATE, JSON.stringify(state));\r\n}\r\n\r\nexport function getThemeCss(dark: boolean) {\r\n  return dark ? \"theme--dark\" : \"theme--light\";\r\n}\r\n\r\nfunction getApp() {\r\n  return document.querySelector(\".m-application\");\r\n}\r\n\r\nfunction updateStorage(obj: Partial<MasaBlazorSsrState>) {\r\n  const stateStr = localStorage.getItem(MASA_BLAZOR_SSR_STATE);\r\n  if (stateStr) {\r\n    const state = JSON.parse(stateStr);\r\n    localStorage.setItem(\r\n      MASA_BLAZOR_SSR_STATE,\r\n      JSON.stringify({\r\n        ...state,\r\n        ...obj,\r\n      })\r\n    );\r\n  }\r\n}\r\n\r\nexport function restoreMain(application: MasaBlazorApplication) {\r\n  const main = document.querySelector(\".m-main\") as HTMLElement;\r\n  if (main && application) {\r\n    main.style.paddingTop = application.top + application.bar + \"px\";\r\n    main.style.paddingRight = application.right + \"px\";\r\n    main.style.paddingBottom =\r\n      application.bottom + application.insetFooter + application.bottom + \"px\";\r\n    main.style.paddingLeft = application.left + \"px\";\r\n  }\r\n}\r\n\r\nexport function getState(): MasaBlazorSsrState {\r\n  const stateStr = localStorage.getItem(MASA_BLAZOR_SSR_STATE);\r\n  if (stateStr) {\r\n    return JSON.parse(stateStr);\r\n  }\r\n  return null;\r\n}\r\n","import { getThemeCss, MASA_BLAZOR_SSR_STATE, MasaBlazorSsrState, restoreMain, setRtl } from \"./\";\r\n\r\nlet firstUpdate = true;\r\n\r\n// Called when the script first gets loaded on the page.\r\nexport function onLoad() {}\r\n\r\n// Called when an enhanced page update occurs, plus once immediately after\r\n// the initial load.\r\nexport function onUpdate() {\r\n  if (firstUpdate) {\r\n    firstUpdate = false;\r\n    return;\r\n  }\r\n\r\n  console.log(\"Update\");\r\n\r\n  const stateStr = localStorage.getItem(MASA_BLAZOR_SSR_STATE);\r\n  console.log(\"[Update] stateStr\", stateStr);\r\n  if (!stateStr) return;\r\n\r\n  const state: MasaBlazorSsrState = JSON.parse(stateStr);\r\n  if (!state) return;\r\n\r\n  console.log(\"[Update] state\", state);\r\n\r\n  restoreMain(state.passive.application);\r\n  restoreTheme(state);\r\n  restoreRtl(state);\r\n}\r\n\r\n// Called when an enhanced page update removes the script from the page.\r\nexport function onDispose() {\r\n  console.log(\"Dispose\");\r\n}\r\n\r\nexport function restoreTheme(state: MasaBlazorSsrState) {\r\n  console.log(\"restoreTheme\", state);\r\n  if (typeof state.dark === \"boolean\") {\r\n    const selector = `.${getThemeCss(!state.dark)}:not(.theme--independent)`\r\n    const elements = document.querySelectorAll(selector);\r\n    for (let i = 0; i < elements.length; i++) {\r\n      elements[i].classList.remove(getThemeCss(!state.dark));\r\n      elements[i].classList.add(getThemeCss(state.dark));\r\n    }\r\n  }\r\n}\r\n\r\nexport function restoreRtl(state: MasaBlazorSsrState) {\r\n  console.log(\"restoreRtl\", state);\r\n  if (typeof state.rtl === \"boolean\") {\r\n    setRtl(state.rtl, false);\r\n  }\r\n}\r\n","import { restoreRtl, restoreTheme } from \"./page-script\";\n\nconst MASA_BLAZOR_SSR_STATE = \"masablazor@ssr-state\";\n\nconst stateStr = localStorage.getItem(MASA_BLAZOR_SSR_STATE);\nif (stateStr) {\n  const state = JSON.parse(stateStr);\n\n  restoreTheme(state);\n  restoreRtl(state);\n}\n\n// function restoreTheme(state) {\n//   console.log('[restoreTheme] state', state.dark)\n//   if (typeof state.dark === \"boolean\") {\n//     const elements = document.querySelectorAll(\".\" + getThemeCss(!state.dark));\n//     console.log('elements', elements)\n//     for (let i = 0; i < elements.length; i++) {\n//       elements[i].classList.remove(getThemeCss(!state.dark));\n//       elements[i].classList.add(getThemeCss(state.dark));\n//     }\n//   }\n// }\n\n// function restoreRtl(state) {\n//   console.log('[restoreRtl] state', state.rtl)\n//   if (typeof state.rtl === \"boolean\") {\n//     const rootElement = document.querySelector(\".m-application\");\n//     console.log('rootElement', rootElement)\n//     const rtlCss = \"m-application--is-rtl\";\n//     if (state.rtl) {\n//       if (!rootElement.classList.contains(rtlCss)) {\n//         rootElement.classList.add(rtlCss);\n//       }\n//     } else {\n//       rootElement.classList.remove(rtlCss);\n//     }\n//   }\n// }\n\n// function getThemeCss(dark) {\n//   return dark ? \"theme--dark\" : \"theme--light\";\n// }\n"],"names":["MASA_BLAZOR_SSR_STATE"],"mappings":"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"}
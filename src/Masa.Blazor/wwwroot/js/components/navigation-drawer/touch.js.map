{"version":3,"file":"touch.js","sources":["../../../../../Masa.Blazor.JS/src/components/navigation-drawer/touch.ts"],"sourcesContent":["import { useVelocity } from \"mixins/touch\";\r\nimport { getElement } from \"utils/helper\";\r\n\r\ntype State = {\r\n  isActive: boolean;\r\n  isTemporary: boolean;\r\n  width: number;\r\n  touchless: boolean;\r\n  position: \"left\" | \"right\" | \"top\" | \"bottom\";\r\n};\r\n\r\nexport function useTouch(\r\n  elOrString: HTMLElement | string,\r\n  dotNetObject: DotNet.DotNetObject,\r\n  state: State\r\n) {\r\n  const el = getElement(elOrString);\r\n\r\n  if (!el) {\r\n    console.warn(\"The root element of MNavigationDrawer component is not found, touching to open/close will not work.\");\r\n    return {};\r\n  }\r\n\r\n  window.addEventListener(\"touchstart\", onTouchstart, { passive: true });\r\n  window.addEventListener(\"touchmove\", onTouchmove, { passive: false });\r\n  window.addEventListener(\"touchend\", onTouchend, { passive: true });\r\n\r\n  const isHorizontal = [\"left\", \"right\"].includes(state.position);\r\n\r\n  const { addMovement, endTouch, getVelocity } = useVelocity();\r\n\r\n  let maybeDragging = false;\r\n  let isDragging = false;\r\n  let dragProgress = 0;\r\n  let offset = 0;\r\n  let start: [number, number] | undefined;\r\n\r\n  let transformBeforeTouchMove = el.style.transform ?? null;\r\n  let transitionBeforeTouchMove = el.style.transition ?? null;\r\n\r\n  function getOffset(pos: number, active: boolean): number {\r\n    return (\r\n      (state.position === \"left\"\r\n        ? pos\r\n        : state.position === \"right\"\r\n        ? document.documentElement.clientWidth - pos\r\n        : state.position === \"top\"\r\n        ? pos\r\n        : state.position === \"bottom\"\r\n        ? document.documentElement.clientHeight - pos\r\n        : oops()) - (active ? state.width : 0)\r\n    );\r\n  }\r\n\r\n  function getProgress(pos: number, limit = true): number {\r\n    const progress =\r\n      state.position === \"left\"\r\n        ? (pos - offset) / state.width\r\n        : state.position === \"right\"\r\n        ? (document.documentElement.clientWidth - pos - offset) / state.width\r\n        : state.position === \"top\"\r\n        ? (pos - offset) / state.width\r\n        : state.position === \"bottom\"\r\n        ? (document.documentElement.clientHeight - pos - offset) / state.width\r\n        : oops();\r\n    return limit ? Math.max(0, Math.min(1, progress)) : progress;\r\n  }\r\n\r\n  function onTouchstart(e: TouchEvent) {\r\n    if (state.touchless) return;\r\n\r\n    transformBeforeTouchMove = el.style.transform ?? null;\r\n    transitionBeforeTouchMove = el.style.transition ?? null;\r\n\r\n    const touchX = e.changedTouches[0].clientX;\r\n    const touchY = e.changedTouches[0].clientY;\r\n\r\n    const touchZone = 25;\r\n    const inTouchZone: boolean =\r\n      state.position === \"left\"\r\n        ? touchX < touchZone\r\n        : state.position === \"right\"\r\n        ? touchX > document.documentElement.clientWidth - touchZone\r\n        : state.position === \"top\"\r\n        ? touchY < touchZone\r\n        : state.position === \"bottom\"\r\n        ? touchY > document.documentElement.clientHeight - touchZone\r\n        : oops();\r\n\r\n    const inElement: boolean =\r\n      state.isActive &&\r\n      (state.position === \"left\"\r\n        ? touchX < state.width\r\n        : state.position === \"right\"\r\n        ? touchX > document.documentElement.clientWidth - state.width\r\n        : state.position === \"top\"\r\n        ? touchY < state.width\r\n        : state.position === \"bottom\"\r\n        ? touchY > document.documentElement.clientHeight - state.width\r\n        : oops());\r\n\r\n    if (inTouchZone || inElement || (state.isActive && state.isTemporary)) {\r\n      start = [touchX, touchY];\r\n\r\n      offset = getOffset(isHorizontal ? touchX : touchY, state.isActive);\r\n      dragProgress = getProgress(isHorizontal ? touchX : touchY);\r\n\r\n      maybeDragging = offset > -20 && offset < 80;\r\n      endTouch(e);\r\n      addMovement(e);\r\n    }\r\n  }\r\n\r\n  function onTouchmove(e: TouchEvent) {\r\n    const touchX = e.changedTouches[0].clientX;\r\n    const touchY = e.changedTouches[0].clientY;\r\n\r\n    if (maybeDragging) {\r\n      if (!e.cancelable) {\r\n        maybeDragging = false;\r\n        return;\r\n      }\r\n\r\n      const dx = Math.abs(touchX - start![0]);\r\n      const dy = Math.abs(touchY - start![1]);\r\n\r\n      const thresholdMet = isHorizontal ? dx > dy && dx > 3 : dy > dx && dy > 3;\r\n\r\n      if (thresholdMet) {\r\n        isDragging = true;\r\n        maybeDragging = false;\r\n      } else if ((isHorizontal ? dy : dx) > 3) {\r\n        maybeDragging = false;\r\n      }\r\n    }\r\n\r\n    applyDragStyles();\r\n\r\n    if (!isDragging) return;\r\n\r\n    e.preventDefault();\r\n    addMovement(e);\r\n\r\n    const progress = getProgress(isHorizontal ? touchX : touchY, false);\r\n    dragProgress = Math.max(0, Math.min(1, progress));\r\n\r\n    if (progress > 1) {\r\n      offset = getOffset(isHorizontal ? touchX : touchY, true);\r\n    } else if (progress < 0) {\r\n      offset = getOffset(isHorizontal ? touchX : touchY, false);\r\n    }\r\n\r\n    dotNetObject.invokeMethodAsync(\"TouchMove\", isDragging, dragProgress);\r\n  }\r\n\r\n  function onTouchend(e: TouchEvent) {\r\n    maybeDragging = false;\r\n\r\n    if (!isDragging) return;\r\n\r\n    addMovement(e);\r\n\r\n    isDragging = false;\r\n\r\n    applyDragStyles();\r\n\r\n    const velocity = getVelocity(e.changedTouches[0].identifier);\r\n    const vx = Math.abs(velocity.x);\r\n    const vy = Math.abs(velocity.y);\r\n    const thresholdMet = isHorizontal ? vx > vy && vx > 400 : vy > vx && vy > 3;\r\n\r\n    if (thresholdMet) {\r\n      state.isActive =\r\n        velocity.direction ===\r\n        ({\r\n          left: \"right\",\r\n          right: \"left\",\r\n          top: \"down\",\r\n          bottom: \"up\",\r\n        }[state.position] || oops());\r\n    } else {\r\n      state.isActive = dragProgress > 0.5;\r\n    }\r\n\r\n    dotNetObject.invokeMethodAsync(\"TouchEnd\", state.isActive);\r\n  }\r\n\r\n  const getDragStyles = () => {\r\n    return isDragging\r\n      ? {\r\n          transform:\r\n            state.position === \"left\"\r\n              ? `translateX(calc(-100% + ${dragProgress * state.width}px))`\r\n              : state.position === \"right\"\r\n              ? `translateX(calc(100% - ${dragProgress * state.width}px))`\r\n              : state.position === \"top\"\r\n              ? `translateY(calc(-100% + ${dragProgress * state.width}px))`\r\n              : state.position === \"bottom\"\r\n              ? `translateY(calc(100% - ${dragProgress * state.width}px))`\r\n              : oops(),\r\n          transition: \"none\",\r\n        }\r\n      : undefined;\r\n  };\r\n\r\n  const applyDragStyles = () => {\r\n    const dragStyles = getDragStyles();\r\n\r\n    if (isDragging) {\r\n      el.style.setProperty(\"transform\", dragStyles?.transform || \"none\");\r\n      el.style.setProperty(\"transition\", dragStyles?.transition || null);\r\n    } else {\r\n      el.style.setProperty(\"transform\", transformBeforeTouchMove);\r\n      el.style.setProperty(\"transition\", transitionBeforeTouchMove);\r\n    }\r\n  };\r\n\r\n  return {\r\n    syncState: (newState: State) => {\r\n      state = newState;\r\n    },\r\n    dispose: () => {\r\n      dotNetObject.dispose();\r\n      window.removeEventListener(\"touchstart\", onTouchstart);\r\n      window.removeEventListener(\"touchmove\", onTouchmove);\r\n      window.removeEventListener(\"touchend\", onTouchend);\r\n    },\r\n  };\r\n}\r\n\r\nfunction oops(): never {\r\n  throw new Error();\r\n}\r\n"],"names":["useTouch","elOrString","dotNetObject","state","el","getElement","console","warn","window","addEventListener","onTouchstart","passive","onTouchmove","onTouchend","isHorizontal","includes","position","addMovement","endTouch","getVelocity","useVelocity","start","maybeDragging","isDragging","dragProgress","offset","transformBeforeTouchMove","_a","style","transform","transitionBeforeTouchMove","_b","transition","getOffset","pos","active","document","documentElement","clientWidth","clientHeight","oops","width","getProgress","limit","progress","Math","max","min","e","touchless","touchX","changedTouches","clientX","touchY","clientY","inTouchZone","inElement","isActive","isTemporary","cancelable","dx","abs","dy","applyDragStyles","preventDefault","invokeMethodAsync","velocity","identifier","vx","x","vy","y","thresholdMet","direction","left","right","top","bottom","dragStyles","undefined","setProperty","syncState","newState","dispose","removeEventListener","Error"],"mappings":"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"}
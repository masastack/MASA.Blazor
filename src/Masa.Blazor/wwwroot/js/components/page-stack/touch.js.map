{"version":3,"file":"touch.js","sources":["../../../../../Masa.Blazor.JS/src/components/page-stack/touch.ts"],"sourcesContent":["import { useVelocity } from \"mixins/touch\";\r\nimport { getElement } from \"utils/helper\";\r\n\r\ntype State = {\r\n  isActive: boolean;\r\n  position: \"left\" | \"right\";\r\n};\r\n\r\nexport function useTouch(\r\n  elOrString: HTMLElement | string,\r\n  dotNetObject: DotNet.DotNetObject,\r\n  state: State\r\n) {\r\n  const el = getElement(elOrString);\r\n\r\n  if (!el) return;\r\n\r\n  window.addEventListener(\"touchstart\", onTouchstart, { passive: true });\r\n  window.addEventListener(\"touchmove\", onTouchmove, { passive: false });\r\n  window.addEventListener(\"touchend\", onTouchend, { passive: true });\r\n\r\n  const isHorizontal = [\"left\", \"right\"].includes(state.position);\r\n\r\n  const { addMovement, endTouch, getVelocity } = useVelocity();\r\n\r\n  let maybeDragging = false;\r\n  let isDragging = false;\r\n  let dragProgress = 0;\r\n  let offset = 0;\r\n  let start: [number, number] | undefined;\r\n\r\n  function getOffset(pos: number, active: boolean): number {\r\n    return (\r\n      (state.position === \"left\"\r\n        ? pos\r\n        : state.position === \"right\"\r\n        ? document.documentElement.clientWidth - pos\r\n        : oops()) - (active ? document.documentElement.clientWidth : 0)\r\n    );\r\n  }\r\n\r\n  function getProgress(pos: number, limit = true): number {\r\n    const progress =\r\n      state.position === \"left\"\r\n        ? (pos - offset) / document.documentElement.clientWidth\r\n        : state.position === \"right\"\r\n        ? (document.documentElement.clientWidth - pos - offset) /\r\n          document.documentElement.clientWidth\r\n        : oops();\r\n    return limit ? Math.max(0, Math.min(1, progress)) : progress;\r\n  }\r\n\r\n  function isActiveElement(e: TouchEvent) {\r\n    const pageStackItem = (e.target as HTMLElement).closest(\".m-page-stack-item\");\r\n    return pageStackItem && pageStackItem.parentElement === el;\r\n  }\r\n\r\n  function onTouchstart(e: TouchEvent) {\r\n    if (!isActiveElement(e)) return;\r\n\r\n    const touchX = e.changedTouches[0].clientX;\r\n    const touchY = e.changedTouches[0].clientY;\r\n\r\n    const touchZone = 25;\r\n    const inTouchZone: boolean =\r\n      state.position === \"left\"\r\n        ? touchX < touchZone\r\n        : state.position === \"right\"\r\n        ? touchX > document.documentElement.clientWidth - touchZone\r\n        : oops();\r\n\r\n    const inElement: boolean =\r\n      state.isActive &&\r\n      (state.position === \"left\"\r\n        ? touchX < document.documentElement.clientWidth\r\n        : state.position === \"right\"\r\n        ? touchX > 0\r\n        : oops());\r\n\r\n    if (inTouchZone || inElement || state.isActive) {\r\n      start = [touchX, touchY];\r\n\r\n      offset = getOffset(isHorizontal ? touchX : touchY, state.isActive);\r\n      dragProgress = getProgress(isHorizontal ? touchX : touchY);\r\n\r\n      maybeDragging = offset > -20 && offset < 80;\r\n      endTouch(e);\r\n      addMovement(e);\r\n    }\r\n  }\r\n\r\n  function onTouchmove(e: TouchEvent) {\r\n    if (!isActiveElement(e)) return;\r\n\r\n    const touchX = e.changedTouches[0].clientX;\r\n    const touchY = e.changedTouches[0].clientY;\r\n\r\n    if (maybeDragging) {\r\n      if (!e.cancelable) {\r\n        maybeDragging = false;\r\n        return;\r\n      }\r\n\r\n      const dx = Math.abs(touchX - start![0]);\r\n      const dy = Math.abs(touchY - start![1]);\r\n\r\n      const thresholdMet = isHorizontal ? dx > dy && dx > 3 : dy > dx && dy > 3;\r\n\r\n      if (thresholdMet) {\r\n        isDragging = true;\r\n        maybeDragging = false;\r\n      } else if ((isHorizontal ? dy : dx) > 3) {\r\n        maybeDragging = false;\r\n      }\r\n    }\r\n\r\n    if (!isDragging) return;\r\n\r\n    e.preventDefault();\r\n    addMovement(e);\r\n\r\n    const progress = getProgress(isHorizontal ? touchX : touchY, false);\r\n    dragProgress = Math.max(0, Math.min(1, progress));\r\n\r\n    if (progress > 1) {\r\n      offset = getOffset(isHorizontal ? touchX : touchY, true);\r\n    } else if (progress < 0) {\r\n      offset = getOffset(isHorizontal ? touchX : touchY, false);\r\n    }\r\n\r\n    applyStyles();\r\n  }\r\n\r\n  function onTouchend(e: TouchEvent) {\r\n    if (!isActiveElement(e)) return;\r\n\r\n    maybeDragging = false;\r\n\r\n    if (!isDragging) return;\r\n\r\n    addMovement(e);\r\n\r\n    isDragging = false;\r\n\r\n    const velocity = getVelocity(e.changedTouches[0].identifier);\r\n    const vx = Math.abs(velocity.x);\r\n    const vy = Math.abs(velocity.y);\r\n    const thresholdMet = isHorizontal ? vx > vy && vx > 400 : vy > vx && vy > 3;\r\n\r\n    if (thresholdMet) {\r\n      state.isActive =\r\n        velocity.direction ===\r\n        ({\r\n          left: \"right\",\r\n          right: \"left\",\r\n          top: \"down\",\r\n          bottom: \"up\",\r\n        }[state.position] || oops());\r\n    } else {\r\n      state.isActive = dragProgress > 0.5;\r\n    }\r\n\r\n    applyStyles();\r\n\r\n    setTimeout(\r\n      () => dotNetObject.invokeMethodAsync(\"TouchEnd\", state.isActive),\r\n      200 // the transition duration of root element is 200ms\r\n    );\r\n  }\r\n\r\n  const applyStyles = () => {\r\n    if (isDragging) {\r\n      const transform =\r\n        state.position === \"left\"\r\n          ? `translateX(calc(-100% + ${\r\n              dragProgress * document.documentElement.clientWidth\r\n            }px))`\r\n          : state.position === \"right\"\r\n          ? `translateX(calc(100% - ${\r\n              dragProgress * document.documentElement.clientWidth\r\n            }px))`\r\n          : oops();\r\n\r\n      el.style.setProperty(\"transform\", transform);\r\n      el.style.setProperty(\"transition\", \"none\");\r\n    } else {\r\n      if (state.isActive) {\r\n        el.style.removeProperty(\"transform\");\r\n      } else {\r\n        el.style.setProperty(\"transform\", \"translateX(100%)\");\r\n      }\r\n\r\n      el.style.removeProperty(\"transition\");\r\n    }\r\n  };\r\n\r\n  return {\r\n    // not used for now\r\n    syncState: (newState: State) => {\r\n      state = newState;\r\n    },\r\n    dispose: () => {\r\n      dotNetObject.dispose();\r\n      window.removeEventListener(\"touchstart\", onTouchstart);\r\n      window.removeEventListener(\"touchmove\", onTouchmove);\r\n      window.removeEventListener(\"touchend\", onTouchend);\r\n    },\r\n  };\r\n}\r\n\r\nfunction oops(): never {\r\n  throw new Error();\r\n}\r\n"],"names":[],"mappings":"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"}
{"version":3,"file":"touch.js","sources":["../../../../../Masa.Blazor.JS/src/components/page-stack/touch.ts"],"sourcesContent":["import { useVelocity } from \"mixins/touch\";\r\nimport { getElement } from \"utils/helper\";\r\n\r\ntype State = {\r\n  isActive: boolean;\r\n  position: \"left\" | \"right\";\r\n};\r\n\r\nexport function useTouch(\r\n  elOrString: HTMLElement | string,\r\n  dotNetObject: DotNet.DotNetObject,\r\n  state: State\r\n) {\r\n  const el = getElement(elOrString);\r\n\r\n  if (!el) return;\r\n\r\n  window.addEventListener(\"touchstart\", onTouchstart, { passive: true });\r\n  window.addEventListener(\"touchmove\", onTouchmove, { passive: false });\r\n  window.addEventListener(\"touchend\", onTouchend, { passive: true });\r\n\r\n  const isHorizontal = [\"left\", \"right\"].includes(state.position);\r\n\r\n  const { addMovement, endTouch, getVelocity } = useVelocity();\r\n\r\n  let maybeDragging = false;\r\n  let isDragging = false;\r\n  let dragProgress = 0;\r\n  let offset = 0;\r\n  let start: [number, number] | undefined;\r\n\r\n  function getOffset(pos: number, active: boolean): number {\r\n    return (\r\n      (state.position === \"left\"\r\n        ? pos\r\n        : state.position === \"right\"\r\n        ? document.documentElement.clientWidth - pos\r\n        : oops()) - (active ? document.documentElement.clientWidth : 0)\r\n    );\r\n  }\r\n\r\n  function getProgress(pos: number, limit = true): number {\r\n    const progress =\r\n      state.position === \"left\"\r\n        ? (pos - offset) / document.documentElement.clientWidth\r\n        : state.position === \"right\"\r\n        ? (document.documentElement.clientWidth - pos - offset) /\r\n          document.documentElement.clientWidth\r\n        : oops();\r\n    return limit ? Math.max(0, Math.min(1, progress)) : progress;\r\n  }\r\n\r\n  function isActiveElement(e: TouchEvent) {\r\n    const pageStackItem = (e.target as HTMLElement).closest(\".m-page-stack-item\");\r\n    return pageStackItem && pageStackItem.parentElement === el;\r\n  }\r\n\r\n  function onTouchstart(e: TouchEvent) {\r\n    if (!isActiveElement(e)) return;\r\n\r\n    const touchX = e.changedTouches[0].clientX;\r\n    const touchY = e.changedTouches[0].clientY;\r\n\r\n    const touchZone = 25;\r\n    const inTouchZone: boolean =\r\n      state.position === \"left\"\r\n        ? touchX < touchZone\r\n        : state.position === \"right\"\r\n        ? touchX > document.documentElement.clientWidth - touchZone\r\n        : oops();\r\n\r\n    const inElement: boolean =\r\n      state.isActive &&\r\n      (state.position === \"left\"\r\n        ? touchX < document.documentElement.clientWidth\r\n        : state.position === \"right\"\r\n        ? touchX > 0\r\n        : oops());\r\n\r\n    if (inTouchZone || inElement || state.isActive) {\r\n      start = [touchX, touchY];\r\n\r\n      offset = getOffset(isHorizontal ? touchX : touchY, state.isActive);\r\n      dragProgress = getProgress(isHorizontal ? touchX : touchY);\r\n\r\n      maybeDragging = offset > -20 && offset < 80;\r\n      endTouch(e);\r\n      addMovement(e);\r\n    }\r\n  }\r\n\r\n  function onTouchmove(e: TouchEvent) {\r\n    if (!isActiveElement(e)) return;\r\n\r\n    const touchX = e.changedTouches[0].clientX;\r\n    const touchY = e.changedTouches[0].clientY;\r\n\r\n    if (maybeDragging) {\r\n      if (!e.cancelable) {\r\n        maybeDragging = false;\r\n        return;\r\n      }\r\n\r\n      const dx = Math.abs(touchX - start![0]);\r\n      const dy = Math.abs(touchY - start![1]);\r\n\r\n      const thresholdMet = isHorizontal ? dx > dy && dx > 3 : dy > dx && dy > 3;\r\n\r\n      if (thresholdMet) {\r\n        isDragging = true;\r\n        maybeDragging = false;\r\n      } else if ((isHorizontal ? dy : dx) > 3) {\r\n        maybeDragging = false;\r\n      }\r\n    }\r\n\r\n    if (!isDragging) return;\r\n\r\n    e.preventDefault();\r\n    addMovement(e);\r\n\r\n    const progress = getProgress(isHorizontal ? touchX : touchY, false);\r\n    dragProgress = Math.max(0, Math.min(1, progress));\r\n\r\n    if (progress > 1) {\r\n      offset = getOffset(isHorizontal ? touchX : touchY, true);\r\n    } else if (progress < 0) {\r\n      offset = getOffset(isHorizontal ? touchX : touchY, false);\r\n    }\r\n\r\n    applyStyles();\r\n  }\r\n\r\n  function onTouchend(e: TouchEvent) {\r\n    if (!isActiveElement(e)) return;\r\n\r\n    maybeDragging = false;\r\n\r\n    if (!isDragging) return;\r\n\r\n    addMovement(e);\r\n\r\n    isDragging = false;\r\n\r\n    const velocity = getVelocity(e.changedTouches[0].identifier);\r\n    const vx = Math.abs(velocity.x);\r\n    const vy = Math.abs(velocity.y);\r\n    const thresholdMet = isHorizontal ? vx > vy && vx > 400 : vy > vx && vy > 3;\r\n\r\n    if (thresholdMet) {\r\n      state.isActive =\r\n        velocity.direction ===\r\n        ({\r\n          left: \"right\",\r\n          right: \"left\",\r\n          top: \"down\",\r\n          bottom: \"up\",\r\n        }[state.position] || oops());\r\n    } else {\r\n      state.isActive = dragProgress > 0.5;\r\n    }\r\n\r\n    applyStyles();\r\n\r\n    setTimeout(\r\n      () => dotNetObject.invokeMethodAsync(\"TouchEnd\", state.isActive),\r\n      200 // the transition duration of root element is 200ms\r\n    );\r\n  }\r\n\r\n  const applyStyles = () => {\r\n    if (isDragging) {\r\n      const transform =\r\n        state.position === \"left\"\r\n          ? `translateX(calc(-100% + ${\r\n              dragProgress * document.documentElement.clientWidth\r\n            }px))`\r\n          : state.position === \"right\"\r\n          ? `translateX(calc(100% - ${\r\n              dragProgress * document.documentElement.clientWidth\r\n            }px))`\r\n          : oops();\r\n\r\n      el.style.setProperty(\"transform\", transform);\r\n      el.style.setProperty(\"transition\", \"none\");\r\n    } else {\r\n      if (state.isActive) {\r\n        el.style.removeProperty(\"transform\");\r\n      } else {\r\n        el.style.setProperty(\"transform\", \"translateX(100%)\");\r\n      }\r\n\r\n      el.style.removeProperty(\"transition\");\r\n    }\r\n  };\r\n\r\n  return {\r\n    // not used for now\r\n    syncState: (newState: State) => {\r\n      state = newState;\r\n    },\r\n    dispose: () => {\r\n      dotNetObject.dispose();\r\n      window.removeEventListener(\"touchstart\", onTouchstart);\r\n      window.removeEventListener(\"touchmove\", onTouchmove);\r\n      window.removeEventListener(\"touchend\", onTouchend);\r\n    },\r\n  };\r\n}\r\n\r\nfunction oops(): never {\r\n  throw new Error();\r\n}\r\n"],"names":["useTouch","elOrString","dotNetObject","state","el","getElement","window","addEventListener","onTouchstart","passive","onTouchmove","onTouchend","isHorizontal","includes","position","addMovement","endTouch","getVelocity","useVelocity","start","maybeDragging","isDragging","dragProgress","offset","getOffset","pos","active","document","documentElement","clientWidth","oops","getProgress","limit","progress","Math","max","min","isActiveElement","e","pageStackItem","target","closest","parentElement","touchX","changedTouches","clientX","touchY","clientY","inTouchZone","inElement","isActive","cancelable","dx","abs","dy","preventDefault","applyStyles","velocity","identifier","vx","x","vy","y","thresholdMet","direction","left","right","top","bottom","setTimeout","invokeMethodAsync","transform","style","setProperty","removeProperty","syncState","newState","dispose","removeEventListener","Error"],"mappings":"gIAQgBA,EACdC,EACAC,EACAC,GAEA,MAAMC,EAAKC,EAAWJ,GAEtB,IAAKG,EAAI,OAETE,OAAOC,iBAAiB,aAAcC,EAAc,CAAEC,SAAS,IAC/DH,OAAOC,iBAAiB,YAAaG,EAAa,CAAED,SAAS,IAC7DH,OAAOC,iBAAiB,WAAYI,EAAY,CAAEF,SAAS,IAE3D,MAAMG,EAAe,CAAC,OAAQ,SAASC,SAASV,EAAMW,WAEhDC,YAAEA,EAAWC,SAAEA,EAAQC,YAAEA,GAAgBC,IAE/C,IAIIC,EAJAC,GAAgB,EAChBC,GAAa,EACbC,EAAe,EACfC,EAAS,EAGb,SAASC,EAAUC,EAAaC,GAC9B,OACsB,SAAnBvB,EAAMW,SACHW,EACmB,UAAnBtB,EAAMW,SACNa,SAASC,gBAAgBC,YAAcJ,EACvCK,MAAWJ,EAASC,SAASC,gBAAgBC,YAAc,EAElE,CAED,SAASE,EAAYN,EAAaO,GAAQ,GACxC,MAAMC,EACe,SAAnB9B,EAAMW,UACDW,EAAMF,GAAUI,SAASC,gBAAgBC,YACvB,UAAnB1B,EAAMW,UACLa,SAASC,gBAAgBC,YAAcJ,EAAMF,GAC9CI,SAASC,gBAAgBC,YACzBC,IACN,OAAOE,EAAQE,KAAKC,IAAI,EAAGD,KAAKE,IAAI,EAAGH,IAAaA,CACrD,CAED,SAASI,EAAgBC,GACvB,MAAMC,EAAiBD,EAAEE,OAAuBC,QAAQ,sBACxD,OAAOF,GAAiBA,EAAcG,gBAAkBtC,CACzD,CAED,SAASI,EAAa8B,GACpB,IAAKD,EAAgBC,GAAI,OAEzB,MAAMK,EAASL,EAAEM,eAAe,GAAGC,QAC7BC,EAASR,EAAEM,eAAe,GAAGG,QAG7BC,EACe,SAAnB7C,EAAMW,SACF6B,EAHY,GAIO,UAAnBxC,EAAMW,SACN6B,EAAShB,SAASC,gBAAgBC,YALtB,GAMZC,IAEAmB,EACJ9C,EAAM+C,WACc,SAAnB/C,EAAMW,SACH6B,EAAShB,SAASC,gBAAgBC,YACf,UAAnB1B,EAAMW,SACN6B,EAAS,EACTb,MAEFkB,GAAeC,GAAa9C,EAAM+C,YACpC/B,EAAQ,CAACwB,EAAQG,GAEjBvB,EAASC,EAAUZ,EAAe+B,EAASG,EAAQ3C,EAAM+C,UACzD5B,EAAeS,EAAYnB,EAAe+B,EAASG,GAEnD1B,EAAgBG,GAAU,IAAMA,EAAS,GACzCP,EAASsB,GACTvB,EAAYuB,GAEf,CAED,SAAS5B,EAAY4B,GACnB,IAAKD,EAAgBC,GAAI,OAEzB,MAAMK,EAASL,EAAEM,eAAe,GAAGC,QAC7BC,EAASR,EAAEM,eAAe,GAAGG,QAEnC,GAAI3B,EAAe,CACjB,IAAKkB,EAAEa,WAEL,YADA/B,GAAgB,GAIlB,MAAMgC,EAAKlB,KAAKmB,IAAIV,EAASxB,EAAO,IAC9BmC,EAAKpB,KAAKmB,IAAIP,EAAS3B,EAAO,KAEfP,EAAewC,EAAKE,GAAMF,EAAK,EAAIE,EAAKF,GAAME,EAAK,IAGtEjC,GAAa,EACbD,GAAgB,IACNR,EAAe0C,EAAKF,GAAM,IACpChC,GAAgB,EAEnB,CAED,IAAKC,EAAY,OAEjBiB,EAAEiB,iBACFxC,EAAYuB,GAEZ,MAAML,EAAWF,EAAYnB,EAAe+B,EAASG,GAAQ,GAC7DxB,EAAeY,KAAKC,IAAI,EAAGD,KAAKE,IAAI,EAAGH,IAEnCA,EAAW,EACbV,EAASC,EAAUZ,EAAe+B,EAASG,GAAQ,GAC1Cb,EAAW,IACpBV,EAASC,EAAUZ,EAAe+B,EAASG,GAAQ,IAGrDU,GACD,CAED,SAAS7C,EAAW2B,GAClB,IAAKD,EAAgBC,GAAI,OAIzB,GAFAlB,GAAgB,GAEXC,EAAY,OAEjBN,EAAYuB,GAEZjB,GAAa,EAEb,MAAMoC,EAAWxC,EAAYqB,EAAEM,eAAe,GAAGc,YAC3CC,EAAKzB,KAAKmB,IAAII,EAASG,GACvBC,EAAK3B,KAAKmB,IAAII,EAASK,GACvBC,EAAenD,EAAe+C,EAAKE,GAAMF,EAAK,IAAME,EAAKF,GAAME,EAAK,EAGxE1D,EAAM+C,SADJa,EAEAN,EAASO,aACR,CACCC,KAAM,QACNC,MAAO,OACPC,IAAK,OACLC,OAAQ,MACRjE,EAAMW,WAAagB,KAENR,EAAe,GAGlCkC,IAEAa,YACE,IAAMnE,EAAaoE,kBAAkB,WAAYnE,EAAM+C,WACvD,IAEH,CAED,MAAMM,EAAc,KAClB,GAAInC,EAAY,CACd,MAAMkD,EACe,SAAnBpE,EAAMW,SACF,2BACEQ,EAAeK,SAASC,gBAAgBC,kBAEvB,UAAnB1B,EAAMW,SACN,0BACEQ,EAAeK,SAASC,gBAAgBC,kBAE1CC,IAEN1B,EAAGoE,MAAMC,YAAY,YAAaF,GAClCnE,EAAGoE,MAAMC,YAAY,aAAc,OACpC,MACKtE,EAAM+C,SACR9C,EAAGoE,MAAME,eAAe,aAExBtE,EAAGoE,MAAMC,YAAY,YAAa,oBAGpCrE,EAAGoE,MAAME,eAAe,aACzB,EAGH,MAAO,CAELC,UAAYC,IACVzE,EAAQyE,CAAQ,EAElBC,QAAS,KACP3E,EAAa2E,UACbvE,OAAOwE,oBAAoB,aAActE,GACzCF,OAAOwE,oBAAoB,YAAapE,GACxCJ,OAAOwE,oBAAoB,WAAYnE,EAAW,EAGxD,CAEA,SAASmB,IACP,MAAM,IAAIiD,KACZ"}
@using System.Diagnostics.CodeAnalysis
@using DeepCloner.Core
@using Masa.Blazor.Components.TemplateTable
@using Masa.Blazor.Components.TemplateTable.ColumnDialogs
@using Masa.Blazor.Components.TemplateTable.FilterDialogs
@using Masa.Blazor.Components.TemplateTable.Viewers
@using Microsoft.JSInterop
@using Masa.Blazor.Components.TemplateTable.Toolbars
@using Masa.Blazor.Components.TemplateTable.SortDialogs
@using Masa.Blazor.Components.TemplateTable.DetailDialogs
@using Masa.Blazor.Components.TemplateTable.Paginations
@namespace Masa.Blazor
@inject IJSRuntime JSRuntime
@inject IPopupService PopupService

@if (_sheet is not null)
{
    <div class="m-template-table">
        <Toolbar DefaultViewId="@_sheet.DefaultViewId"
                 ActiveView="@_sheet.ActiveViewId"
                 ActiveViewChanged="@HandleOnActiveViewChanged"
                 ColumnOrder="@_columnOrder"
                 ColumnOrderChanged="@HandleOnColumnOrderChanged"
                 RowHeight="_rowHeight"
                 RowHeightChanged="@HandleOnRowHeightChanged"
                 PageSizeOptions="@_sheet.Pagination.PageSizeOptions"
                 PageSizeOptionsChanged="@HandleOnPageSizeOptionsChanged"
                 Views="_sheet.Views"
                 Columns="_sheet.Columns"
                 HiddenColumnIds="@_sheet.ActiveViewHiddenColumnIds"
                 OnViewAdd="@AddNewView"
                 OnViewReset="@ResetView"
                 OnViewRename="@RenameView"
                 OnViewDelete="@DeleteView"
                 OnColumnEditClick="@OpenColumnEditDialog"
                 OnColumnToggle="@ToggleColumn"
                 HasSelectedKeys="@(SelectedKeys.Count > 0)"
                 HasActions="@_sheet.ActiveViewHasActions"
                 HasSelect="@_sheet.ActiveViewShowSelect"
                 HasCustom="@HasCustomConfiguration"
                 HasFilter="@(_sheet.ActiveView?.Value?.Filter?.Options.Count > 0)"
                 HasSort="@(_sheet.ActiveView?.Value?.Sort?.Options.Count > 0)"
                 OnFilterClick="@(() => _filterDialog?.Open())"
                 OnSortClick="@(() => _sortDialog?.Open())"
                 OnRowRemove="@Remove"
                 OnSearch="@Search"
                 OnSave="@SaveSheet"/>

        <Viewer ViewColumns="@_sheet.ActiveViewColumns"
                HiddenColumnIds="@_sheet.ActiveViewHiddenColumnIds"
                ColumnOrder="@_columnOrder"
                ColumnOrderChanged="@HandleOnColumnOrderChanged"
                Loading="@_loading"
                RowHeight="@_rowHeight"
                Rows="@_rows"
                Sort="@_sheet.ActiveView?.Value?.Sort"
                OnSortUpdate="@SortUpdate"
                HasActions="@_sheet.ActiveViewHasActions"
                ShowSelect="@_sheet.ActiveViewShowSelect"
                Height="@Height"
                OnColumnToggle="@ToggleColumn"
                OnColumnEditClick="@OpenColumnEditDialog"
                OnColumnResize="@ResizeColumn"
                OnImagePreview="@OpenImageViewer"
                Detail="@Detail"
                OnDetail="@OpenDetailDialog"
                CheckboxColor="@CheckboxColor"
                SelectedKeys="@SelectedKeys"
                OnSelect="@HandleOnSelect"
                OnSelectAll="@HandleOnSelectAll"
                ActionsContent="@ActionsContent"
                @ref="_viewer">
        </Viewer>

        @if (_sheet.ActiveView is not null)
        {
            var pageStart = (_sheet.ActiveView.PageIndex - 1) * _sheet.ActiveView.PageSize;
            var pageStop = Math.Min(_sheet.ActiveView.PageIndex * _sheet.ActiveView.PageSize, _totalCount);

            <Pagination PageIndex="@_sheet.ActiveView.PageIndex"
                        PageStart="@pageStart"
                        PageStop="@pageStop"
                        ItemsPerPage="@_sheet.ActiveView.PageSize"
                        ItemsLength="@_totalCount"
                        PageSizeOptions="@_sheet.Pagination.PageSizeOptions"
                        OnPaginationUpdate="@HandleOnPaginationUpdateAsync">
            </Pagination>
        }

        <ColumnDialog @ref="_columnEditDialog"
                      OnSave="@UpdateColumn">
        </ColumnDialog>

        <FilterDialog @ref="_filterDialog"
                      ActiveView="@_sheet.ActiveView?.Value"
                      Columns="@_sheet.Columns"
                      HiddenColumnIds="@_sheet.ActiveViewHiddenColumnIds"
                      OnSave="@SaveFilter">
        </FilterDialog>

        <SortDialog @ref="_sortDialog"
                    ActiveView="@_sheet.ActiveView?.Value"
                    Columns="@_sheet.Columns"
                    HiddenColumnIds="@_sheet.ActiveViewHiddenColumnIds"
                    OnSave="@SortUpdate">
        </SortDialog>

        <ImageViewer @ref="_imageViewer"/>

        <DetailDialog @ref="_detailDialog" OnImagePreview="@OpenImageViewer"/>
    </div>
}

@code {

    private List<string> _columnOrder = [];
    private RowHeight _rowHeight;
    private Viewer? _viewer;

    private ICollection<string>? _defaultColumnIds;

    private ColumnDialog? _columnEditDialog;
    private FilterDialog? _filterDialog;
    private SortDialog? _sortDialog;
    private DetailDialog? _detailDialog;
    private ImageViewer? _imageViewer;

    private bool HasCustomConfiguration
    {
        get
        {
            if (_sheet.ActiveView is null)
            {
                return false;
            }

            ICollection<string> columnIds = [];
            foreach (var column in _sheet.ActiveView.Columns)
            {
                if (column.Hidden)
                {
                    return true;
                }

                columnIds.Add(column.ColumnId);
            }

            _defaultColumnIds ??= _sheet.Columns.Select(u => u.Id).ToList();
            _defaultColumnIds.Remove(Preset.ActionsColumnId);
            columnIds.Remove(Preset.ActionsColumnId);

            return !_defaultColumnIds.SequenceEqual(columnIds);
        }
    }

    private void AddNewView()
    {
        var clonedView = _sheet.ActiveView.DeepClone();
        clonedView.Value.Id = Guid.NewGuid();
        clonedView.Value.Name = "Copy of " + clonedView.Value.Name;

        _sheet.Views.Add(clonedView);
        _sheet.ActiveViewId = clonedView.Value.Id;

        ResetSheet();
    }

    private async Task ResetView()
    {
        _sheet.ActiveView.Value.Columns = _sheet.Columns.Where(u => u.Id != Preset.ActionsColumnId).Select(u => new ViewColumn(u.Id)).ToList();
        _columnOrder = [];
        _sheet.ActiveView.Value.Filter = new();
        _sheet.ActiveView.Value.Sort = null;
        _sheet.ActiveView.PageIndex = 1;
        await RefreshItemsAsync(GetItemsProviderRequest());
    }

    private void RenameView((Guid id, string Name) args)
    {
        var view = _sheet.Views.FirstOrDefault(u => u.Value.Id == args.id);
        if (view is not null)
        {
            view.Value.Name = args.Name;
        }
    }

    private async Task DeleteView(View view)
    {
        if (_sheet.Views.Count < 1)
        {
            return;
        }

        var confirmed =
            await PopupService.ConfirmAsync(
                "Delete view",
                $"Are you sure you want to delete this view ({view.Name})?",
                AlertTypes.Error);

        if (!confirmed) return;

        var viewInfo = _sheet.Views.FirstOrDefault(v => v.Value.Id == view.Id);
        _sheet.Views.Remove(viewInfo);

        if (_sheet.ActiveViewId == view.Id)
        {
            _sheet.ActiveViewId = _sheet.Views.First().Value.Id;
        }
    }

    private async Task HandleOnActiveViewChanged(Guid viewId)
    {
        _sheet!.SetActiveView(viewId);

        ResetSheet();

        if (_sheet.ActiveView.Rows is null)
        {
            _sheet.ActiveView.PageIndex = 1;
            _sheet.ActiveView.PageSize = 5; // TODO:使用用户输入的值

            await RefreshItemsAsync(GetItemsProviderRequest());
        }
        else
        {
            _rows = _sheet.ActiveView.Rows;
        }
    }

    private void ResetSheet()
    {
        // reset the width of the table
        _ = JSRuntime.InvokeVoidAsync(JsInteropConstants.SetStyle, _viewer?.GetTableSelector(), "width", null);

        UpdateStateOfActiveView();
    }

    private void HandleOnColumnOrderChanged(List<string> columnOrder)
    {
        _columnOrder = columnOrder;

        if (!_columnOrder.Contains(Preset.ActionsColumnId))
        {
            _columnOrder.Add(Preset.ActionsColumnId);
        }

        Console.Out.WriteLine("[TemplateTable] ColumnOrderChanged Before: " + string.Join(",", _columnOrder));
        if (!_columnOrder.Contains(Preset.RowSelectColumnId))
        {
            _columnOrder.Insert(0, Preset.RowSelectColumnId);
        }

        Console.Out.WriteLine("[TemplateTable] ColumnOrderChanged: " + string.Join(",", _columnOrder));

        _sheet.ActiveViewColumns.Sort((x, y) =>
        {
            var xIndex = _columnOrder.IndexOf(x.ColumnId);
            var yIndex = _columnOrder.IndexOf(y.ColumnId);
            return xIndex.CompareTo(yIndex);
        });
    }

    private void HandleOnRowHeightChanged(RowHeight rowHeight)
    {
        _rowHeight = rowHeight;
        _sheet.UpdateActiveViewRowHeight(rowHeight);
    }

    private async Task HandleOnPageSizeOptionsChanged(List<int> pageSizeOptions)
    {
        _sheet.Pagination.PageSizeOptions = pageSizeOptions;
        if (pageSizeOptions.Count == 0)
        {
            return;
        }

        pageSizeOptions.Sort();

        if (!pageSizeOptions.Contains(_sheet.ActiveView.PageSize))
        {
            _sheet.ActiveView.PageIndex = 1;
            _sheet.ActiveView.PageSize = pageSizeOptions.First();

            await RefreshItemsAsync(GetItemsProviderRequest());
        }
    }

    private void ToggleColumn(string columnId)
    {
        if (columnId == Preset.ActionsColumnId)
        {
            _sheet.ActiveView!.Value.HasActions = !_sheet.ActiveView.Value.HasActions;
            return;
        }

        if (columnId == Preset.RowSelectColumnId)
        {
            _sheet.ActiveView!.Value.ShowSelect = !_sheet.ActiveView.Value.ShowSelect;
            return;
        }

        var viewColumn = _sheet.ActiveViewColumns.FirstOrDefault(u => u.ColumnId == columnId);
        viewColumn.Hidden = !viewColumn.Hidden;
    }

    private void OpenColumnEditDialog(Column column)
    {
        _columnEditDialog?.Open(column);
    }

    private void OpenDetailDialog(IReadOnlyDictionary<string, JsonElement> item)
    {
        List<DetailItem> detailItems = [];
        foreach (var viewColumn in _sheet.ActiveViewColumns)
        {
            var key = item.Keys.FirstOrDefault(u => string.Equals(u, viewColumn.ColumnId, StringComparison.OrdinalIgnoreCase));
            if (key is null || _sheet.ActiveViewHiddenColumnIds.Contains(viewColumn.ColumnId))
            {
                continue;
            }

            detailItems.Add(new DetailItem(viewColumn.Column, item[key]));
        }

        _detailDialog?.Open(detailItems);
    }

    private void OpenImageViewer(IList<string> images)
    {
        _imageViewer?.Open(images);
    }

    private string? ItemKeyName => _sheet.ItemKeyName;
    private List<string> SelectedKeys => _sheet.ActiveView.Selection.Select(u => u.Key).ToList();

    private void HandleOnSelect((Row, bool) args)
    {
        var (item, selected) = args;

        _sheet.ActiveView.Selection.Remove(item);
        if (selected)
        {
            _sheet.ActiveView.Selection.Add(item);
        }

        _ = UpdateSelectedValue().ConfigureAwait(false);

        StateHasChanged();
    }

    private async Task UpdateSelectedValue()
    {
        if (SelectedChanged.HasDelegate)
        {
            await SelectedChanged.InvokeAsync(
                _sheet.ActiveView.Selection.Select(u => u.Key).ToArray()
            );
        }
    }

    private void HandleOnSelectAll(bool selected)
    {
        if (_sheet.ActiveView?.Rows is null)
        {
            return;
        }

        _sheet.ActiveView.Selection.Clear();
        if (selected)
        {
            foreach (var item in _sheet.ActiveView.Rows)
            {
                if (item.Key is not null)
                {
                    _sheet.ActiveView.Selection.Add(item);
                }
            }
        }

        UpdateSelectedValue().ConfigureAwait(false);

        StateHasChanged();
    }

    private void UpdateColumn(ColumnInfo data)
    {
        var column = _sheet.Columns.FirstOrDefault(u => u.Id == data.Id);
        if (column is null)
        {
            return;
        }

        column.Name = data.Name;
        column.Type = data.Type;
        column.Config = data.Config;
        column.ConfigObject = data.ConfigObject;
        column.Searchable = data.Searchable;

        // var viewColumn = _viewColumns.FirstOrDefault(u => u.Column.Id == data.Id);
        // viewColumn.Column = column;
    }

    private async Task SaveFilter(Filter filter)
    {
        _sheet.ActiveView.Value.Filter = filter;
        _sheet.ActiveView.PageIndex = 1;
        await RefreshItemsAsync(GetItemsProviderRequest());
    }

    private async Task SortUpdate(Sort sort)
    {
        _sheet.ActiveView.Value.Sort = sort;
        _sheet.ActiveView.PageIndex = 1;
        await RefreshItemsAsync(GetItemsProviderRequest());
    }

    private async Task Search()
    {
        _sheet.ActiveView.PageIndex = 1;
        await RefreshItemsAsync(GetItemsProviderRequest());
    }

    private async Task Remove()
    {
        await OnRemove.InvokeAsync(_sheet.ActiveView.Selection);
    }

    private void ResizeColumn((string ColumnId, double Width) args)
    {
        var viewColumn = _sheet.ActiveViewColumns.FirstOrDefault(u => u.ColumnId == args.ColumnId);
        if (viewColumn is null)
        {
            return;
        }

        viewColumn.Width = args.Width;
    }

    private async Task SaveSheet()
    {
        var sheet = new Sheet()
        {
            Columns = _sheet.Columns.Where(u => !Preset.InternalColumnIds.Contains(u.Id)).Select(Column (u) => u),
            Views = _sheet.Views.Select(View (u) => u.ToView()).ToList(),
            Pagination = _sheet.Pagination,
            ActiveViewId = _sheet.ActiveViewId,
            DefaultViewId = _sheet.DefaultViewId,
            ItemKeyName = _sheet.ItemKeyName
        };
        await OnSave.InvokeAsync(sheet);
    }

}
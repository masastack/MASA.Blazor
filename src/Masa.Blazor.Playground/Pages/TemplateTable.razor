@using System.Text.Json
@using GraphQL.Client.Http
@using Masa.Blazor.Components.TemplateTable
@using Masa.Blazor.Components.TemplateTable.Actions
@inject GraphQLHttpClient GraphQLClient

<MTemplateTable SheetProvider="@_sheetProvider"
                UserViewsProvider="@_userViewsProvider"
                ItemsProvider="@_itemsProvider"
                Height="300"
                OnSave="@Save"
                CheckboxColor="primary"
                OnRemove="@Remove">
    <ViewActionsContent>
        <MButton OnClick="@(() => OnExport(context))" Color="primary">Export</MButton>
    </ViewActionsContent>
    <RowActionsContent>
        <DetailAction/>
        <UpdateAction/>
        <DeleteAction Icon="mdi-delete-variant" Tooltip="删除" OnClick="OnDelete"/>
        <ActionTemplate Icon="mdi-home" Tooltip="Custom Action !" OnClick="OnCustomAction"/>
    </RowActionsContent>
</MTemplateTable>

@code {
    
    private void OnCustomAction(IReadOnlyDictionary<string, JsonElement> data)
    {
        Console.Out.WriteLine($"Custom Action Clicked {data["name"].GetString()}");
    }

    private async Task OnDelete(IReadOnlyDictionary<string, JsonElement> data)
    {
        await PopupService.ConfirmAsync("Are you sure to delete this item?", data["name"].GetString(), AlertTypes.Warning, async _ =>
        {
            await Task.Delay(1000);
            Console.Out.WriteLine("Deleted");
        });
    }

    private async Task Remove(ICollection<Row> items)
    {
        var keyString = string.Join(", ", items.Select(u => u.Key));
        var message = $"Are you sure to delete {items.Count()} items({keyString})?";
        var confirmed = await PopupService.ConfirmAsync(message, AlertTypes.Warning);
        if (confirmed)
        {
            Console.Out.WriteLine("Deleted");
        }
    }

    private async Task OnExport(ICollection<Row> items)
    {
        Console.Out.WriteLine("Export: "+string.Join(',', items.Select(u => u.Key)));
    }

}
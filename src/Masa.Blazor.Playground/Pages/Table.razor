@using System.Text.Json
@using Masa.Blazor.MasaTable
@inject IJSRuntime JSRuntime


<MTemplateTable OnSave="SaveSheet"
                Sheet="@_sheet"
                Items="@_myRecords"
                Height="300"
                ColumnTemplate="@ColumnTemplate"
                OnUpdate="@HandleOnUpdate"
                OnDelete="@HandleOnDelete"
                OnAction1="@(() => { })"
                TItem="MyRecord">
</MTemplateTable>


@code {

    #region mock data

    public class MyRecord
    {
        public string? Name { get; set; }
        public string? Description { get; set; }
        public int Age { get; set; }
        public bool GoOrNot { get; set; }
        public string? Homepage { get; set; }
        public DateTimeOffset Birthday { get; set; }
        public int Favorite { get; set; }
        public int[] Favorites { get; set; }
        public int Progress { get; set; }
        public double Rating { get; set; }
        public string Image { get; set; }
        public string[] Images { get; set; }
    }

    public static class MyRecordMock
    {
        public static List<MyRecord> GetMockData()
        {
            return new List<MyRecord>
            {
                new MyRecord
                {
                    Name = "John Doe",
                    Description = "A simple description",
                    Age = 30,
                    GoOrNot = true,
                    Homepage = "https://example.com",
                    Birthday = DateTimeOffset.Now,
                    Favorite = 1,
                    Favorites = [1, 2],
                    Progress = 12,
                    Rating = 2,
                    Image = "https://cdn.masastack.com/stack/images/website/masa-blazor/cards/halcyon.png",
                    Images = ["https://cdn.masastack.com/stack/images/website/masa-blazor/cards/halcyon.png"]
                },
                new MyRecord
                {
                    Name = "Jane Doe",
                    Description = "Another simple description",
                    Age = 25,
                    GoOrNot = false,
                    Homepage = "https://example.com",
                    Birthday = DateTimeOffset.Now.AddDays(-300),
                    Favorite = 2,
                    Favorites = [2, 3],
                    Progress = 13,
                    Rating = 1,
                    Image = "https://cdn.masastack.com/stack/images/website/masa-blazor/cards/halcyon.png",
                    Images = ["https://cdn.masastack.com/stack/images/website/masa-blazor/cards/halcyon.png"]
                },
                new MyRecord
                {
                    Name = "John Smith",
                    Description = "A simple description",
                    Age = 30,
                    GoOrNot = true,
                    Homepage = "https://example.com",
                    Birthday = DateTimeOffset.Now.AddDays(-100),
                    Favorite = 3,
                    Favorites = [4],
                    Progress = 14,
                    Rating = 3.5,
                    Image = "https://cdn.masastack.com/stack/images/website/masa-blazor/cards/halcyon.png",
                    Images = ["https://cdn.masastack.com/stack/images/website/masa-blazor/cards/halcyon.png"]
                },
                new MyRecord
                {
                    Name = "Jane Smith",
                    Description = "Another simple description",
                    Age = 25,
                    GoOrNot = false,
                    Homepage = "https://example.com",
                    Birthday = DateTimeOffset.Now.AddDays(-672),
                    Favorite = 4,
                    Favorites = [1, 3, 4],
                    Progress = 14,
                    Rating = 4,
                    Image = "https://cdn.masastack.com/stack/images/website/masa-blazor/cards/halcyon.png",
                    Images = ["https://cdn.masastack.com/stack/images/website/masa-blazor/cards/halcyon.png"]
                },
                new MyRecord
                {
                    Name = "John Doe",
                    Description = "A simple description",
                    Age = 30,
                    GoOrNot = true,
                    Homepage = "https://example.com",
                    Birthday = DateTimeOffset.Now.AddDays(-1000),
                    Favorite = 0,
                    Favorites = [2],
                    Progress = 12,
                    Rating = 3,
                    Image = "https://cdn.masastack.com/stack/images/website/masa-blazor/cards/halcyon.png",
                    Images = ["https://cdn.masastack.com/stack/images/website/masa-blazor/cards/halcyon.png"]
                },
                new MyRecord
                {
                    Name = "Jane Doe",
                    Description = "Another simple description",
                    Age = 25,
                    GoOrNot = false,
                    Homepage = "https://example.com",
                    Birthday = DateTimeOffset.Now.AddDays(-120),
                    Favorite = 3,
                    Favorites = [0],
                    Progress = 10,
                    Rating = 1.5,
                    Image = "https://cdn.masastack.com/stack/images/website/masa-blazor/cards/halcyon.png",
                    Images = ["https://cdn.masastack.com/stack/images/website/masa-blazor/cards/halcyon.png"]
                },
                new MyRecord
                {
                    Name = "John Smith",
                    Description = "A simple description",
                    Age = 30,
                    GoOrNot = true,
                    Homepage = "https://example.com",
                    Birthday = DateTimeOffset.Now.AddDays(-88),
                    Favorite = 2,
                    Favorites = [3, 4],
                    Progress = 14,
                    Rating = 0,
                    Image = "https://cdn.masastack.com/stack/images/website/masa-blazor/cards/halcyon.png",
                    Images = ["https://cdn.masastack.com/stack/images/website/masa-blazor/cards/halcyon.png"]
                },
                new MyRecord
                {
                    Name = "Jane Smith",
                    Description = "Another simple description",
                    Age = 25,
                    GoOrNot = false,
                    Homepage = "https://example.com",
                    Birthday = DateTimeOffset.Now.AddDays(-300),
                    Favorite = 1,
                    Favorites = [1, 2, 3],
                    Progress = 15,
                    Rating = 5,
                    Image = "https://cdn.masastack.com/stack/images/website/masa-blazor/cards/halcyon.png",
                    Images = ["https://cdn.masastack.com/stack/images/website/masa-blazor/cards/halcyon.png"]
                },
                new MyRecord
                {
                    Name = "John Doe",
                    Description = "A simple description",
                    Age = 30,
                    GoOrNot = true,
                    Homepage = "https://example.com",
                    Birthday = DateTimeOffset.Now.AddDays(-100),
                    Favorite = 2,
                    Favorites = [4],
                    Progress = 12,
                    Rating = 3,
                    Image = "https://cdn.masastack.com/stack/images/website/masa-blazor/cards/halcyon.png",
                    Images = ["https://cdn.masastack.com/stack/images/website/masa-blazor/cards/halcyon.png"]
                },
                new MyRecord
                {
                    Name = "Jane Doe",
                    Description = "Another simple description",
                    Age = 25,
                    GoOrNot = false,
                    Homepage = "https://example.com",
                    Birthday = DateTimeOffset.Now.AddDays(-1000),
                    Favorite = 3,
                    Favorites = [1, 2],
                    Progress = 13,
                    Rating = 1,
                    Image = "https://cdn.masastack.com/stack/images/website/masa-blazor/cards/halcyon.png",
                    Images = ["https://cdn.masastack.com/stack/images/website/masa-blazor/cards/halcyon.png"]
                },
                new MyRecord
                {
                    Name = "John Smith",
                    Description = "A simple description",
                    Age = 30,
                    GoOrNot = true,
                    Homepage = "https://example.com",
                    Birthday = DateTimeOffset.Now.AddDays(-300),
                    Favorite = 4,
                    Favorites = [3],
                    Progress = 14,
                    Rating = 3.5,
                    Image = "https://cdn.masastack.com/stack/images/website/masa-blazor/cards/halcyon.png",
                    Images = ["https://cdn.masastack.com/stack/images/website/masa-blazor/cards/halcyon.png"]
                },
                new MyRecord
                {
                    Name = "Jane Smith",
                    Description = "Another simple description",
                    Age = 25,
                    GoOrNot = false,
                    Homepage = "https://example.com",
                    Birthday = DateTimeOffset.Now.AddDays(-100),
                    Favorite = 1,
                    Favorites = [2, 3, 4],
                    Progress = 14,
                    Rating = 4,
                    Image = "https://cdn.masastack.com/stack/images/website/masa-blazor/cards/halcyon.png",
                    Images = ["https://cdn.masastack.com/stack/images/website/masa-blazor/cards/halcyon.png"]
                },
                new MyRecord
                {
                    Name = "John Doe",
                    Description = "A simple description",
                    Age = 30,
                    GoOrNot = true,
                    Homepage = "https://example.com",
                    Birthday = DateTimeOffset.Now.AddDays(-1000),
                    Favorite = 0,
                    Favorites = [2],
                    Progress = 12,
                    Rating = 3,
                    Image = "https://cdn.masastack.com/stack/images/website/masa-blazor/cards/halcyon.png",
                    Images = ["https://cdn.masastack.com/stack/images/website/masa-blazor/cards/halcyon.png"]
                },
                new MyRecord
                {
                    Name = "Jane Doe",
                    Description = "Another simple description",
                    Age = 25,
                    GoOrNot = false,
                    Homepage = "https://example.com",
                    Birthday = DateTimeOffset.Now.AddDays(-120),
                    Favorite = 3,
                    Favorites = [0],
                    Progress = 10,
                    Rating = 1.5,
                    Image = "https://cdn.masastack.com/stack/images/website/masa-blazor/cards/halcyon.png",
                    Images = ["https://cdn.masastack.com/stack/images/website/masa-blazor/cards/halcyon.png"]
                },
                new MyRecord
                {
                    Name = "John Smith",
                    Description = "A simple description",
                    Age = 30,
                    GoOrNot = true,
                    Homepage = "https://example.com",
                    Birthday = DateTimeOffset.Now.AddDays(-88),
                    Favorite = 2,
                    Favorites = [3, 4],
                    Progress = 14,
                    Rating = 0,
                    Image = "https://cdn.masastack.com/stack/images/website/masa-blazor/cards/halcyon.png",
                    Images = ["https://cdn.masastack.com/stack/images/website/masa-blazor/cards/halcyon.png"]
                },
                new MyRecord
                {
                    Name = "Jane Smith",
                    Description = "Another simple description",
                    Age = 25,
                    GoOrNot = false,
                    Homepage = "https://example.com",
                    Birthday = DateTimeOffset.Now.AddDays(-300),
                    Favorite = 1,
                    Favorites = [1, 2, 3],
                    Progress = 15,
                    Rating = 5,
                    Image = "https://cdn.masastack.com/stack/images/website/masa-blazor/cards/halcyon.png",
                    Images = ["https://cdn.masastack.com/stack/images/website/masa-blazor/cards/halcyon.png"]
                },
                new MyRecord
                {
                    Name = "John Doe",
                    Description = "A simple description",
                    Age = 30,
                    GoOrNot = true,
                    Homepage = "https://example.com",
                    Birthday = DateTimeOffset.Now.AddDays(-100),
                    Favorite = 2,
                    Favorites = [4],
                    Progress = 12,
                    Rating = 3,
                    Image = "https://cdn.masastack.com/stack/images/website/masa-blazor/cards/halcyon.png",
                    Images = ["https://cdn.masastack.com/stack/images/website/masa-blazor/cards/halcyon.png"]
                },
            };
        }
    }

    #endregion

    [Inject] private LocalStorage LocalStorage { get; set; } = null!;

    private List<MyRecord> _myRecords = new();
    private Sheet? _sheet;

    private Func<ValueTask<Sheet>> _sheetProvider;

    private List<ColumnTemplate<MyRecord, object>> ColumnTemplate(MyRecord record)
    {
        var name = new ColumnTemplate<MyRecord, object>(nameof(record.Name), ColumnType.Text, u => u.Name);
        var age = new ColumnTemplate<MyRecord, object>(nameof(record.Age), ColumnType.Number, u => u.Age);
        var getOrNot = new ColumnTemplate<MyRecord, object>(nameof(record.GoOrNot), ColumnType.Checkbox, u => u.GoOrNot);
        var birthday = new ColumnTemplate<MyRecord, object>(nameof(record.Birthday), ColumnType.Date, u => u.Birthday);
        var homepage = new ColumnTemplate<MyRecord, object>(nameof(record.Homepage), ColumnType.Link, u => u.Homepage);
        var favorite = new ColumnTemplate<MyRecord, object>(nameof(record.Favorite), ColumnType.Select, u => u.Favorite);
        var favorites = new ColumnTemplate<MyRecord, object>(nameof(record.Favorites), ColumnType.MultiSelect, u => u.Favorites);
        var progress = new ColumnTemplate<MyRecord, object>(nameof(record.Progress), ColumnType.Progress, u => u.Progress);
        var rating = new ColumnTemplate<MyRecord, object>(nameof(record.Rating), ColumnType.Rating, u => u.Rating);
        var image = new ColumnTemplate<MyRecord, object>(nameof(record.Image), ColumnType.Image, u => u.Image);
        var images = new ColumnTemplate<MyRecord, object>(nameof(record.Images), ColumnType.Image, u => u.Images);

        return [name, image, age, getOrNot, homepage, birthday, favorite, favorites, progress, rating];
    }

    private async Task SaveSheet(Sheet sheet)
    {
        // TODO: save sheet

        var json = JsonSerializer.Serialize(sheet);

        await LocalStorage.SetItemAsync("sheet", json);
        await JSRuntime.InvokeVoidAsync(JsInteropConstants.Log, sheet);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _myRecords = MyRecordMock.GetMockData();
            _sheet = await LocalStorage.GetItemAsync<Sheet>("sheet");
            StateHasChanged();
        }
    }

    private void HandleOnUpdate(MyRecord record)
    {
        Console.Out.WriteLine("Update record");
    }

    private void HandleOnDelete(MyRecord record)
    {
        Console.Out.WriteLine("Delete record");
    }

}